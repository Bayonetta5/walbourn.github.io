---
layout: post
title: Windows Imaging Component and Windows 8
date: 2012-11-19 15:07
author: walbourn
comments: true
categories: [Uncategorized, win7, win8, xbox one]
---
<p>There are a number of new features and some bugs fixed in the <a href="http://msdn.microsoft.com/en-us/library/hh994467.aspx">Windows Imaging Component for Windows 8</a>. With the installation of <a href="http://blogs.msdn.com/b/chuckw/archive/2013/02/26/directx-11-1-and-windows-7-update.aspx">KB 2670838</a>&nbsp;this new version of WIC is also available on Windows 7 Service Pack 1.</p>
<p>The <a href="http://blogs.msdn.com/b/chuckw/archive/2012/08/15/visual-studio-2012-and-windows-8-0-sdk-rtm-are-now-available.aspx">Windows 8.0 SDK</a> contains the latest version of the headers needed to build with the new version of WIC. The behavior of <code>wincodec.h</code> changes depending your build-settings. If you build with <code>_WIN32_WINNT</code> set to 0x602 or later, then <code>WINCODEC_SDK_VERSION</code>, <code>CLSID_WICImagingFactory</code>, and <code>CLSID_WICPngDecoder</code> are set to use "WIC2" by default. Otherwise, it uses the old "WIC1" version. This means Windows Store apps and Win32 desktop applications built for Windows 8 only are already using the new version of WIC. No muss. No fuss. Win32 desktop applications built for older versions of Windows continue to use "WIC1" and the old behaviors are maintained.</p>
<p>If, however, you want to use "WIC2" when it is available but successfully fall back to "WIC1" on Windows Vista or Windows 7 without the KB 2670838 update, then things get a little tricky. The <code>_WIN7_PLATFORM_UPDATE</code> define 'opts-in' to the Windows 8 header behavior without requiring you set your <code>_WIN32_WINNT</code> define in a way that doesn't support older versions of Windows. You will want to <em>avoid</em> using <code>WINCODEC_SDK_VERSION</code>, <code>CLSID_WICImagingFactory</code>, and <code>CLSID_WICPngDecoder</code> and instead use the explicit 'version' ones. You also need to be careful when using the four new WIC pixel format GUIDs (<code>GUID_WICPixelFormat32bppRGB, GUID_WICPixelFormat64bppRGB, GUID_WICPixelFormat96bppRGBFloat</code>, and <code>GUID_WICPixelFormat64bppPRGBAHalf</code>) as they are not valid for use with "WIC1" APIs.</p>
<p>For example, here is how you should be creating the WIC factory for Win32 desktop applications that support older versions of Windows:</p>
<pre class="scroll"><code class="cplusplus"> #define _WIN7_PLATFORM_UPDATE<br /> #include &lt;wincodec.h&gt;<br /> <br /> // CoInitializeEx needs called at some point before this <br /> <br /> IWICImagingFactory* wicFactory = nullptr;<br /> HRESULT hr = CoCreateInstance(CLSID_WICImagingFactory2, nullptr, CLSCTX_INPROC_SERVER, __uuidof(IWICImagingFactory2), reinterpret_cast&lt;LPVOID*&gt;( &amp;wicFactory ) );<br /> if ( SUCCEEDED(hr) )<br /> {<br /> // WIC2 is available on Windows 8 and Windows 7 SP1 with KB 2670838 installed<br /> // Note you only need to QI IWICImagingFactory2 if you need to call CreateImageEncoder<br /> }<br /> else<br /> {<br /> hr = CoCreateInstance(CLSID_WICImagingFactory1, nullptr, CLSCTX_INPROC_SERVER, __uuidof(IWICImagingFactory), reinterpret_cast&lt;LPVOID*&gt;( &amp;wicFactory ) );<br /> }</code></pre>
<p>This results in the application using the new "WIC2" behaviors when available, but falls back to the older versions of WIC when it's not available.</p>
<p><a href="http://directxtk.codeplex.com/">DirectXTK</a> and <a href="http://directxtex.codeplex.com/">DirectXTex</a> were both recently updated to support "WIC2" when it is available. This includes use of new WIC pixel formats ( <code>GUID_WICPixelFormat96bppRGBFloat</code> is the most useful since it matches <code>DXGI_FORMAT_R32G32B32_FLOAT</code> ), opts into the new Windows BMP <code>BITMAPV5HEADER</code> support (which encodes 32-bit with alpha channels for <code>GUID_WICPixelFormat32bppBGRA</code> and reads such BMP files as well), and can make use of the fix to the TIFF decoder for 96bpp floating-point images (which load as <code>GUID_WICPixelFormat96bppRGBFloat</code>).</p>
<p><strong>Windows phone:</strong> Note that the Windows phone 8.0 platform does not support the WIC API, but Windows phone 8.1 does include it.</p>
<p><strong>Xbox One:</strong> The Xbox One platform includes "WIC2". The HD Photo / JPEG XR codec is not currently&nbsp;supported for Xbox One XDK&nbsp;development.</p>
<p><strong>VS 2012 Update 1: </strong>When building with the "<a href="http://blogs.msdn.com/b/chuckw/archive/2012/11/26/visual-studio-2012-update-1.aspx">v110_xp</a>" Platform Toolset, the WIC2 header content is not available so avoid the use of <code>_WIN7_PLATFORM_UPDATE</code> for these configurations.</p>
<p><strong>Windows 8.1</strong>: There are a few additional changes to WIC with Windows 8.1 including support for a limited DDS codec. See <a href="http://msdn.microsoft.com/en-us/library/windows/desktop/dn280986.aspx">MSDN</a>.</p>
